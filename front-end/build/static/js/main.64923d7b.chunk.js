(this["webpackJsonpfront-end"]=this["webpackJsonpfront-end"]||[]).push([[0],{189:function(e,t,a){e.exports=a(396)},194:function(e,t,a){},205:function(e,t,a){},211:function(e,t){},212:function(e,t){},213:function(e,t){},214:function(e,t){},215:function(e,t){},216:function(e,t){},396:function(e,t,a){"use strict";a.r(t);var n,r,c=a(0),i=a.n(c),o=a(9),s=a.n(o),l=(a(194),a(74)),u=a(35),m=a(36),d=a(23),p=a(51),f=a(52),h=a(70),v=a.n(h),b=a(398),E=a(404),w=a(397),g=a(405),y=(a(205),a(186)),k=a(12),x=a.n(k),O=a(29),j=a(82),S=a(168),C=a(59),R=a(401),z=a(399),I=a(14),P=a(406),N=a(407),A=a(408),L=a(409),D=a(410),T={labelCol:{span:6},wrapperCol:{span:16}},B={wrapperCol:{offset:6,span:16}};function U(){return M.apply(this,arguments)}function M(){return(M=Object(O.a)(x.a.mark((function e(){var t,a;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,I.d("https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_1.0_224/model.json");case 2:return t=e.sent,a=t.getLayer("conv_pw_13_relu"),e.abrupt("return",I.e({inputs:t.inputs,outputs:a.output}));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _(e){return F.apply(this,arguments)}function F(){return(F=Object(O.a)(x.a.mark((function e(t){return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){setTimeout((function(){e()}),t)})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var W=new(function(){function e(){Object(u.a)(this,e)}return Object(m.a)(e,[{key:"addExample",value:function(e,t){var a=I.i((function(){return I.h(t,[1,2])}));if(null==this.xs)this.xs=I.b(e),this.ys=I.b(a);else{var n=this.xs;this.xs=I.b(n.concat(e,0));var r=this.ys;this.ys=I.b(r.concat(a,0)),n.dispose(),r.dispose(),a.dispose()}}},{key:"clean",value:function(){this.xs.dispose(),this.ys.dispose(),this.xs=null,this.ys=null}}]),e}()),H=j.a.Option,K=!1,q=function(e){Object(f.a)(a,e);var t=Object(p.a)(a);function a(e){var i;return Object(u.a)(this,a),(i=t.call(this,e)).exampleCleanHandler=Object(O.a)(x.a.mark((function e(){return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i.setState({exampleList:[]}),W.clean();case 2:case"end":return e.stop()}}),e)}))),i.exampleHandler=function(){var e=Object(O.a)(x.a.mark((function e(t){var a,r,c,o,s,l,u,m,p,f,h;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return K=!0,a=Object(d.a)(i),r=a.state.exampleList,c=a.props,o=c.action,s=c.canvasRef,l=I.a.fromPixels(s),u=l.resizeNearestNeighbor([224,224]),m=I.i((function(){return u.expandDims(0).toFloat().div(127).sub(1)})),f=(p=t||o).speed,h=p.direction,console.log("example",p),W.addExample(n.predict(m),[f,h]),e.next=11,I.a.toPixels(u,i.smallCanvasRef.current);case 11:r.push({img:i.smallCanvasRef.current.toDataURL(),action:{speed:f,direction:h}}),i.setState({exampleList:r}),l.dispose(),K=!1;case 15:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),i.train=function(){var e=Object(O.a)(x.a.mark((function e(t){var a,c;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i.setState({isTraining:!0}),console.log("Learnning Argument",t),null!=W.xs){e.next=4;break}throw new Error("Add some examples before training!");case 4:if(r=I.g({layers:[I.c.flatten({inputShape:n.outputs[0].shape.slice(1)}),I.c.dense({units:t.hiddenUnits,activation:"relu",kernelInitializer:"varianceScaling",useBias:!0}),I.c.dense({units:2,kernelInitializer:"varianceScaling",useBias:!1,activation:"softmax"})]}),a=I.j.adam(t.learnRate),r.compile({optimizer:a,loss:"meanSquaredError"}),(c=Math.floor(W.xs.shape[0]*t.batchSize))>0){e.next=10;break}throw new Error("Batch size is 0 or NaN. Please choose a non-zero fraction.");case 10:r.fit(W.xs,W.ys,{batchSize:c,epochs:t.epochs,callbacks:{onBatchEnd:function(){var e=Object(O.a)(x.a.mark((function e(t,a){return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("Loss: "+a.loss.toFixed(5)),i.setState({loss:a.loss.toFixed(5)});case 2:case"end":return e.stop()}}),e)})));return function(t,a){return e.apply(this,arguments)}}(),onTrainEnd:function(e){i.setState({isTraining:!1})}}});case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),i.predict=Object(O.a)(x.a.mark((function e(){var t,a,c,o;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=Object(d.a)(i),a=t.props,c=a.canvasRef,(o=a.onAi)(!0),i.setState({isPredicting:!0},Object(O.a)(x.a.mark((function e(){var t,a,s,l,u,m,d,p;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!i.state.isPredicting){e.next=20;break}return e.next=3,_(200);case 3:return t=I.i((function(){return I.a.fromPixels(c).resizeNearestNeighbor([224,224]).expandDims(0).toFloat().div(127).sub(1)})),a=n.predict(t),s=r.predict(a),e.next=8,s.data();case 8:return l=e.sent,u=Object(y.a)(l,2),m=u[0],d=u[1],p={speed:m,direction:d},console.log("Ai \u52a8\u4f5c\uff1a",p),t.dispose(),i.doAction(p),e.next=18,I.f();case 18:e.next=0;break;case 20:o(!1);case 21:case"end":return e.stop()}}),e)}))));case 3:case"end":return e.stop()}}),e)}))),i.record=Object(O.a)(x.a.mark((function e(){return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i.setState({isRecording:!0});case 1:case"end":return e.stop()}}),e)}))),i.state={learnForm:{},exampleList:[],loading:!1,training:!1,isPredicting:!1,isRecording:!1,loss:0,learnArgument:{learnRate:.001,batchSize:.4,epochs:20,hiddenUnits:100}},i.smallCanvasRef=Object(c.createRef)(),i}return Object(m.a)(a,[{key:"componentDidMount",value:function(){var e=Object(O.a)(x.a.mark((function e(){return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setState({loading:!0}),e.next=3,U();case 3:n=e.sent,this.setState({loading:!1});case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"componentDidUpdate",value:function(e,t){e.action!==this.props.action&&this.state.isRecording&&!K&&this.exampleHandler(this.props.action)}},{key:"doAction",value:function(){var e=Object(O.a)(x.a.mark((function e(t){var a;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.speed,a=t.direction,this.props.controller.direction(a);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this,t=this.state,a=t.exampleList,n=t.loading,r=t.isRecording,c=t.isTraining,o=t.isPredicting,s=t.loss,l=t.learnArgument,u=this.exampleHandler,m=this.exampleCleanHandler,d=this.record,p=this.predict;return i.a.createElement(S.a,{spinning:n},i.a.createElement("canvas",{className:"ai-canvas",ref:this.smallCanvasRef}),i.a.createElement(b.a,Object.assign({},T,{initialValues:l,onFinish:this.train}),i.a.createElement(b.a.Item,{label:"Learning rate",name:"learnRate"},i.a.createElement(g.a,null)),i.a.createElement(b.a.Item,{label:"Batch Size",name:"batchSize"},i.a.createElement(j.a,null,i.a.createElement(H,{value:.05},"0.05"),i.a.createElement(H,{value:.1},"0.1"),i.a.createElement(H,{value:.4},"0.4"),i.a.createElement(H,{value:1},"1"))),i.a.createElement(b.a.Item,{label:"Epochs",name:"epochs"},i.a.createElement(j.a,null,i.a.createElement(H,{value:10},"10"),i.a.createElement(H,{value:20},"20"),i.a.createElement(H,{value:40},"40"))),i.a.createElement(b.a.Item,{label:"Hidden units",name:"hiddenUnits"},i.a.createElement(j.a,null,i.a.createElement(H,{value:100},"100"),i.a.createElement(H,{value:200},"200"),i.a.createElement(H,{value:300},"300"),i.a.createElement(H,{value:400},"400"),i.a.createElement(H,{value:500},"500"))),i.a.createElement(b.a.Item,{label:"loss"},i.a.createElement(g.a,{value:s})),i.a.createElement(b.a.Item,B,i.a.createElement(C.a,{type:"primary",htmlType:"submit",key:"fit",loading:c,disabled:!a.length},"\u5b66\u4e60"))),i.a.createElement(b.a,Object.assign({},T,{initialValues:{speed:0,direction:0},onFinish:function(e){return u(e)}}),i.a.createElement(b.a.Item,{name:"speed",label:"\u901f\u5ea6",required:!0},i.a.createElement(g.a,null)),i.a.createElement(b.a.Item,{name:"direction",label:"\u65b9\u5411",required:!0},i.a.createElement(g.a,null)),i.a.createElement(b.a.Item,Object.assign({},B,{className:"form-item-button"}),i.a.createElement(C.a,{key:"record-once",htmlType:"submit",type:"primary",icon:i.a.createElement(P.a,null)}),i.a.createElement(C.a,{type:"primary",icon:i.a.createElement(N.a,null),onClick:function(){return u({speed:1,direction:1})}}),i.a.createElement(C.a,{type:"primary",icon:i.a.createElement(A.a,null),onClick:function(){return u({speed:1,direction:-1})}}),i.a.createElement(C.a,{type:"primary",icon:i.a.createElement(L.a,null),onClick:function(){return u({speed:1,direction:0})}}),i.a.createElement(C.a,{type:"primary",key:"record",loading:r,onClick:d},"\u5f00\u59cb\u8bb0\u5f55"),i.a.createElement(C.a,{key:"stop",onClick:function(){e.setState({isRecording:!1})},disabled:!r},"\u505c\u6b62\u8bb0\u5f55"),i.a.createElement(C.a,{type:"danger",disabled:!a.length,onClick:m},"\u6e05\u9664")),i.a.createElement(b.a.Item,Object.assign({},B,{className:"form-item-button"}),i.a.createElement(C.a,{type:"danger",key:"predic",loading:o,onClick:p},"\u5f00\u59cb Ai \u9a7e\u9a76"),i.a.createElement(C.a,{onClick:function(){e.setState({isPredicting:!1})},disabled:!o,key:"stop"},"\u505c\u6b62 Ai \u9a7e\u9a76"))),i.a.createElement(R.a,{size:"small",className:"ai-example-list",grid:{gutter:16,column:4},itemLayout:"vertical",pagination:{pageSize:12},dataSource:a,renderItem:function(e){var t=e.img,a=e.action,n=a.speed,r=a.direction;return i.a.createElement(R.a.Item,null,i.a.createElement(z.a,{size:"small",title:"\u901f\u5ea6\uff1a".concat(n,"    \u65b9\u5411\uff1a").concat(r),actions:[i.a.createElement(C.a,{size:"small",icon:i.a.createElement(D.a,null),type:"danger"})]},i.a.createElement("img",{style:{maxWidth:"100%"},src:t,alt:"example"})))}}))}}]),a}(c.Component),V=a(83),Z=a(403);function J(e){return i.a.createElement(Z.a,Object.assign({mode:"horizontal"},e),i.a.createElement(Z.a.Item,null,i.a.createElement(V.a,{to:"setting"},"\u8bbe\u7f6e")),i.a.createElement(Z.a.Item,null,i.a.createElement("a",{href:"https://space.bilibili.com/96740361",target:"_blank",rel:"noopener noreferrer"},"up \u4e3bB\u7ad9\u4e3b\u9875")))}var $,G=a(402),Q=a(411),X=a(412),Y=a(413),ee=a(414),te=a(415),ae=function(e){Object(f.a)(a,e);var t=Object(p.a)(a);function a(e){var n;return Object(u.a)(this,a),(n=t.call(this,e)).handleKeyDown=function(e){var t=Object(d.a)(n).props,a=t.controller,r=a.speed,c=a.direction,i=t.onControl,o=t.forwardPower,s=t.backwardPower,l=e.key;"w"===l&&r(1*o/100),"s"===l&&r(-1*s/100),"a"===l&&c(1),"d"===l&&c(-1),i&&i()},n.handleKeyUp=function(e){var t=Object(d.a)(n).props,a=t.controller,r=a.speed,c=a.direction,i=t.onControl,o=e.key;"w"===o&&r(0),"s"===o&&r(0),"a"===o&&c(0),"d"===o&&c(0),i&&i()},n.keyboardBind=function(){var e=Object(d.a)(n),t=e.handleKeyDown,a=e.handleKeyUp;window.document.addEventListener("keydown",t,!1),window.document.addEventListener("keyup",a,!1)},n.ref=Object(c.createRef)(),n}return Object(m.a)(a,[{key:"componentDidMount",value:function(){this.keyboardBind()}},{key:"componentWillUnmount",value:function(){var e=this.handleKeyDown,t=this.handleKeyUp;window.document.removeEventListener("keydown",e,!1),window.document.removeEventListener("keyup",t,!1)}},{key:"render",value:function(){return i.a.createElement("div",null)}}]),a}(c.Component);window.addEventListener("deviceorientation",(function(e){var t=e.alpha,a=e.beta,n=e.gamma;$={alpha:t,beta:a,gamma:n}}));var ne=function(e){Object(f.a)(a,e);var t=Object(p.a)(a);function a(e){var n;return Object(u.a)(this,a),(n=t.call(this,e)).deviceorientation=function(e){e.alpha;var t=e.beta,a=(e.gamma,Object(d.a)(n)),r=a.props.controller,c=a.state,i=c.directionReverse,o=c.isAiControlling,s=c.zeroOrientation;if(s&&!o){var l=t-s.beta;l=(l=l<-30?-30:l)>30?30:l,r.direction(l/30*(i?-1:1))}},n.state={zeroOrientation:void 0,directionReverse:v.a.get("directionReverse")||!0,backwardPower:50,forwardPower:50},n}return Object(m.a)(a,[{key:"componentDidMount",value:function(){window.addEventListener("deviceorientation",this.deviceorientation)}},{key:"componentWillUnmount",value:function(){window.removeEventListener("deviceorientation",this.handleSetZeroOrientation)}},{key:"render",value:function(){var e=this,t=this.props,a=t.directionReverse,n=t.controller,r=this.state,c=r.forwardPower,o=r.backwardPower;return i.a.createElement("div",{className:"controller"},i.a.createElement(b.a,{className:"controller-form",size:"small",layout:"inline"},i.a.createElement(b.a.Item,null,i.a.createElement(C.a,{type:"danger",onClick:function(){e.setState({zeroOrientation:Object(l.a)({},$)})},icon:i.a.createElement(Q.a,null)},"\u8235\u673a\u6821\u51c6")),i.a.createElement(b.a.Item,{label:"\u8235\u673a\u53cd\u5411"},i.a.createElement(w.a,{checked:a,onChange:function(t){e.setState({directionReverse:t}),v.a.set("directionReverse",t)}})),i.a.createElement(C.a,{className:"left-button",shape:"circle",size:"large",type:"primary",onTouchStart:function(){n.direction(1)},onTouchEnd:function(){n.direction(0)},icon:i.a.createElement(X.a,null)}),i.a.createElement(C.a,{className:"right-button",shape:"circle",size:"large",type:"primary",onTouchStart:function(){n.direction(-1)},onTouchEnd:function(){n.direction(0)},icon:i.a.createElement(Y.a,null)}),i.a.createElement(C.a,{className:"forward-button",shape:"circle",size:"large",type:"primary",onTouchStart:function(){n.speed(1*c/100)},onTouchEnd:function(){n.speed(0)},icon:i.a.createElement(ee.a,null)}),i.a.createElement(C.a,{className:"backward-button",shape:"circle",size:"large",type:"primary",onTouchStart:function(){n.speed(-1*o/100)},onTouchEnd:function(){n.speed(0)},icon:i.a.createElement(te.a,null)}),i.a.createElement(b.a.Item,{label:"\u524d\u8fdb\u6cb9\u95e8"},i.a.createElement(G.a,{value:c,min:0,max:100,onChange:function(t){e.setState({forwardPower:t})},style:{width:"15vw"}})),i.a.createElement(b.a.Item,{label:"\u5012\u9000\u6cb9\u95e8"},i.a.createElement(G.a,{value:o,min:0,max:100,style:{width:"15vw"},onChange:function(t){e.setState({backwardPower:t})}}))),i.a.createElement(ae,{controller:n,backwardPower:o,forwardPower:c}))}}]),a}(c.Component),re=a(188),ce=a(400);function ie(e){e.onDisconnect,e.wsConnected;var t=e.onSubmit,a=Object(re.a)(e,["onDisconnect","wsConnected","onSubmit"]);return i.a.createElement(b.a,Object.assign({},T,{onFinish:t,initialValues:a}),i.a.createElement("br",null),i.a.createElement(b.a.Item,{label:"\u8fde\u63a5\u5730\u5740",name:"wsAddress",rules:[{required:!0,message:"\u8bf7\u8f93\u5165\u8fde\u63a5\u5730\u5740!"}]},i.a.createElement(ce.a,null)),i.a.createElement(b.a.Item,{label:"\u6700\u5927\u901f\u5ea6",name:"speedMax"},i.a.createElement(G.a,{min:0,max:100,tooltipVisible:!0})),i.a.createElement(b.a.Item,B,i.a.createElement(C.a,{type:"primary",htmlType:"submit"},"\u4fdd\u5b58")))}var oe=a(183),se=a.n(oe),le=a(416),ue=function(e){Object(f.a)(a,e);var t=Object(p.a)(a);function a(e){var n;return Object(u.a)(this,a),(n=t.call(this,e)).connect=function(){var e=n.state.setting.wsAddress;n.wsavc.connect("".concat("https:"===window.location.protocol?"wss://":"ws://").concat(e)),n.wsavc.on("disconnected",(function(){console.log("WS disconnected"),n.setState({wsConnected:!1,cameraEnabled:!1})})),n.wsavc.on("connected",(function(){console.log("WS connected"),n.setState({wsConnected:!0})})),n.wsavc.on("frame_shift",(function(e){})),n.wsavc.on("resized",(function(e){console.log("resized",e)})),n.wsavc.on("stream_active",(function(e){console.log("Stream is ",e?"active":"offline"),e&&n.playerBoxRef.current.appendChild(n.wsavc.AvcPlayer.canvas),n.setState({cameraEnabled:e})}))},n.disconnect=function(e){e&&e.preventDefault(),n.setState({wsConnected:!1}),n.wsavc&&n.wsavc.disconnect()},n.changeCamera=function(e){n.wsavc&&n.wsavc.send("open camera",e)},n.changeSetting=function(e){n.setState({setting:e}),v.a.set("setting",e)},n.changeZeroSpeedRate=function(e){n.state.wsConnected&&(n.wsavc.send("speed zero rate",e),n.setState({speedZeroRate:e}))},n.changeSpeed=function(e){n.state.wsConnected&&n.wsavc.send("speed rate",e)},n.changeDirection=function(e){n.state.wsConnected&&n.wsavc.send("direction rate",e)},n.appRef=Object(c.createRef)(),n.playerBoxRef=Object(c.createRef)(),n.state={setting:Object(l.a)({speedMax:20,wsAddress:window.location.host},v.a.get("setting")),wsConnected:!1,cameraEnabled:!1,canvasRef:void 0,isAiControlling:!1,action:{speed:0,direction:0}},n.controller={speed:function(e){var t=Object(d.a)(n),a=t.changeSpeed,r=t.state,c=r.setting.speedMax,i=r.action;i.speed=e*c/100,n.setState({action:Object(l.a)({},i)}),a(i.speed)},direction:function(e){var t=Object(d.a)(n),a=t.changeDirection,r=t.state.action;r.direction=e,a(e),n.setState({action:Object(l.a)({},r)})}},n}return Object(m.a)(a,[{key:"componentDidMount",value:function(){var e=this.connect;this.wsavc=new se.a({useWorker:!0}),e()}},{key:"render",value:function(){var e=this,t=this.disconnect,a=this.connect,n=this.controller,r=this.changeSetting,c=this.changeCamera,o=this.state,s=o.setting,l=o.wsConnected,u=o.cameraEnabled,m=o.canvasRef,d=o.action;return i.a.createElement("div",{className:"App",ref:this.appRef},i.a.createElement(b.a,{layout:"inline",className:"app-status",size:"small"},i.a.createElement(b.a.Item,null,i.a.createElement(V.b,null,(function(e){var t=e.navigate;return i.a.createElement(E.a.Button,{overlay:J,onClick:function(){return t("/")},type:"primary"},i.a.createElement(le.a,null)," \u63a7\u5236")}))),i.a.createElement(b.a.Item,{label:"\u8fde\u63a5\u72b6\u6001"},i.a.createElement(w.a,{checked:l,onChange:function(e){e?a():t()}})),i.a.createElement(b.a.Item,{label:"\u6444\u50cf\u5934"},i.a.createElement(w.a,{checked:u,onChange:c})),i.a.createElement(b.a.Item,{label:"\u8235\u673a"},i.a.createElement(g.a,{value:d.direction})),i.a.createElement(b.a.Item,{label:"\u7535\u8c03"},i.a.createElement(g.a,{value:d.speed}))),i.a.createElement(V.c,{className:"app-page"},i.a.createElement(ne,{path:"/",controller:n}),i.a.createElement(ie,Object.assign({path:"setting"},s,{wsConnected:l,onDisconnect:t,onSubmit:r})),i.a.createElement(q,{path:"ai",canvasRef:m,action:d,controller:n,onAi:function(t){return e.setState({isAiControlling:t})}})),i.a.createElement("div",{className:"player-box",ref:this.playerBoxRef,style:{display:u?"flex":"hidden"}}))}}]),a}(c.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(i.a.createElement(i.a.StrictMode,null,i.a.createElement(ue,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[189,1,2]]]);
//# sourceMappingURL=main.64923d7b.chunk.js.map